name: Cost of Living Content Generation

on:
  schedule:
    # Run 2x per week (Tue/Fri at 09:00 UTC)
    - cron: '0 9 * * 2,5'  # Tuesday and Friday at 9:00 AM UTC
  workflow_dispatch:
    inputs:
      city:
        description: 'City name (e.g., London)'
        required: false
        default: 'London'
        type: string
      country:
        description: 'Country name (e.g., UK)'
        required: false
        default: 'UK'
        type: string
      year:
        description: 'Year'
        required: false
        default: '2026'
        type: string
      comparison_city:
        description: 'Comparison city (optional, for comparison articles)'
        required: false
        type: string
      mode:
        description: 'Article mode'
        required: false
        default: 'city'
        type: choice
        options:
          - 'city'
          - 'comparison'
          - 'budget'
      dry_run:
        description: 'Dry run (test only, no articles created)'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'

jobs:
  generate-cost-of-living:
    name: Generate Cost of Living Article
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Debug - Show workflow info
        run: |
          echo "üîç Workflow Debug Info:"
          echo "   Event: ${{ github.event_name }}"
          echo "   Ref: ${{ github.ref }}"
          echo "   SHA: ${{ github.sha }}"
          echo "   Workflow: ${{ github.workflow }}"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "   Inputs:"
            echo "     City: ${{ github.event.inputs.city }}"
            echo "     Country: ${{ github.event.inputs.country }}"
            echo "     Year: ${{ github.event.inputs.year }}"
          fi
      
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Mask secrets in logs
        run: |
          echo "::add-mask::${{ secrets.GEMINI_API_KEY }}"
          echo "::add-mask::${{ secrets.SANITY_API_TOKEN }}"
          echo "::add-mask::${{ secrets.UNSPLASH_ACCESS_KEY }}"
          echo "::add-mask::${{ secrets.YOUTUBE_API_KEY }}"
      
      - name: Verify secrets are configured
        run: |
          # Check for either Vertex AI or Google AI Studio API
          if [ -z "${{ secrets.GCP_PROJECT_ID }}" ] && [ -z "${{ secrets.GEMINI_API_KEY }}" ]; then
            echo "‚ùå Either GCP_PROJECT_ID (for Vertex AI) or GEMINI_API_KEY (for Google AI Studio) must be configured!"
            exit 1
          fi
          if [ -z "${{ secrets.SANITY_API_TOKEN }}" ]; then
            echo "‚ùå SANITY_API_TOKEN not configured in GitHub Secrets!"
            exit 1
          fi
          if [ -n "${{ secrets.GCP_PROJECT_ID }}" ]; then
            echo "‚úÖ Vertex AI configured (GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }})"
          else
            echo "‚úÖ Google AI Studio API configured"
          fi
          echo "‚úÖ All required secrets are configured"
      
      - name: Setup Vertex AI credentials
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}
        run: |
          # Only setup credentials if GCP_PROJECT_ID is set
          if [ -z "$GCP_PROJECT_ID" ]; then
            echo "‚ÑπÔ∏è GCP_PROJECT_ID not set, skipping Vertex AI credentials setup"
            exit 0
          fi
          
          if [ -z "$GOOGLE_APPLICATION_CREDENTIALS_JSON" ]; then
            echo "‚ùå GOOGLE_APPLICATION_CREDENTIALS_JSON not set - Vertex AI requires credentials"
            exit 1
          fi
          
          CREDS_FILE="${{ runner.temp }}/gcp-credentials.json"
          echo "$GOOGLE_APPLICATION_CREDENTIALS_JSON" > "$CREDS_FILE"
          
          # Verify file was created and is valid JSON
          if [ ! -f "$CREDS_FILE" ]; then
            echo "‚ùå Failed to create credentials file"
            exit 1
          fi
          
          # Check if it's valid JSON (using jq if available, otherwise skip validation)
          if command -v jq > /dev/null 2>&1; then
            if ! jq empty "$CREDS_FILE" > /dev/null 2>&1; then
              echo "‚ùå Credentials file is not valid JSON"
              exit 1
            fi
            echo "‚úÖ JSON validation passed (using jq)"
          else
            echo "‚ö†Ô∏è jq not available, skipping JSON validation (Vertex AI will validate on use)"
          fi
          
          echo "GOOGLE_APPLICATION_CREDENTIALS=$CREDS_FILE" >> $GITHUB_ENV
          echo "‚úÖ Vertex AI credentials file created and verified at $CREDS_FILE"
          
          # Verify file permissions and readability
          chmod 600 "$CREDS_FILE"
          if [ -r "$CREDS_FILE" ]; then
            echo "‚úÖ Credentials file is readable"
          else
            echo "‚ùå Credentials file is not readable"
            exit 1
          fi
      
      - name: Verify credentials before generation
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_LOCATION: ${{ secrets.GCP_LOCATION }}
        run: |
          # Only verify if GCP_PROJECT_ID is set
          if [ -z "$GCP_PROJECT_ID" ]; then
            echo "‚ÑπÔ∏è GCP_PROJECT_ID not set, skipping credentials verification"
            exit 0
          fi
          
          if [ -z "$GOOGLE_APPLICATION_CREDENTIALS" ]; then
            echo "‚ùå GOOGLE_APPLICATION_CREDENTIALS environment variable not set"
            exit 1
          fi
          if [ ! -f "$GOOGLE_APPLICATION_CREDENTIALS" ]; then
            echo "‚ùå Credentials file not found: $GOOGLE_APPLICATION_CREDENTIALS"
            exit 1
          fi
          echo "‚úÖ Credentials file verified: $GOOGLE_APPLICATION_CREDENTIALS"
          echo "‚úÖ GCP_PROJECT_ID: $GCP_PROJECT_ID"
          echo "‚úÖ GCP_LOCATION: ${GCP_LOCATION:-us-central1}"
      
      - name: Ensure Cost of Living pillar exists
        env:
          SANITY_API_TOKEN: ${{ secrets.SANITY_API_TOKEN }}
          NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
          NEXT_PUBLIC_SANITY_DATASET: production
        run: |
          echo "üèõÔ∏è Checking if Cost of Living pillar page exists..."
          node scripts/create-costofliving-pillar.js || echo "‚ö†Ô∏è Pillar creation script completed (may already exist)"
      
      - name: Generate Cost of Living Article
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_LOCATION: ${{ secrets.GCP_LOCATION || 'us-central1' }}
          GOOGLE_APPLICATION_CREDENTIALS: ${{ env.GOOGLE_APPLICATION_CREDENTIALS }}
          GEMINI_MODEL: ${{ secrets.GEMINI_MODEL || 'gemini-2.5-pro' }}
          SANITY_API_TOKEN: ${{ secrets.SANITY_API_TOKEN }}
          NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
          NEXT_PUBLIC_SANITY_DATASET: production
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger
            CITY="${{ github.event.inputs.city || 'London' }}"
            COUNTRY="${{ github.event.inputs.country || 'UK' }}"
            YEAR="${{ github.event.inputs.year || '2026' }}"
            COMPARISON_CITY="${{ github.event.inputs.comparison_city }}"
            MODE="${{ github.event.inputs.mode || 'city' }}"
            DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"
            
            # Validate required inputs
            if [ -z "$CITY" ] || [ -z "$COUNTRY" ]; then
              echo "‚ùå City and Country are required!"
              exit 1
            fi
            
            echo "üèôÔ∏è Generating Cost of Living article:"
            echo "   City: $CITY"
            echo "   Country: $COUNTRY"
            echo "   Year: $YEAR"
            if [ -n "$COMPARISON_CITY" ] && [ "$COMPARISON_CITY" != "" ]; then
              echo "   Comparison City: $COMPARISON_CITY"
            fi
            echo "   Mode: $MODE"
            echo "   Dry Run: $DRY_RUN"
            
            # Build command arguments
            ARGS=("$CITY" "$COUNTRY" "$YEAR")
            if [ -n "$COMPARISON_CITY" ] && [ "$COMPARISON_CITY" != "" ]; then
              ARGS+=("$COMPARISON_CITY")
              if [ -n "$MODE" ] && [ "$MODE" != "" ]; then
                ARGS+=("$MODE")
              fi
            elif [ -n "$MODE" ] && [ "$MODE" != "" ]; then
              ARGS+=("" "$MODE")
            fi
            
            if [ "$DRY_RUN" = "true" ]; then
              echo ""
              echo "üîç DRY RUN MODE - Will validate but not create article"
              echo "   (Note: Dry run still checks duplicates and validates structure)"
              DRY_RUN=1 node scripts/ai-costofliving-generator.js "${ARGS[@]}" || echo "‚úÖ Dry run validation completed"
            else
              node scripts/ai-costofliving-generator.js "${ARGS[@]}"
            fi
          else
            # Scheduled trigger - process queue
            echo "üìã Processing queue (scheduled run)..."
            node scripts/process-costofliving-queue.js
          fi
